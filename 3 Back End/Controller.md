# [Controller](https://symfony.com/doc/5.4/controller.html)

PHP function (action) that returns a Response object

- Input / Arguments =  Route Wildcards, Type-hint to a Class (Symfony Request object, Doctrine Entity, other Services)
- Output / Return = Symfony Response object (JSON, HTML, i.e. front-end of page)

- keep slim
- abstract to helper and services
```php
//src/Controller/LuckyController.php

namespace App\Controller;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Request;  //symfony makes the use keyword import the class
use Symfony\Component\HttpFoundation\Response; //controllers HAVE to return a Response object

class LuckyController extends AbstractController  //'Controller' suffix is convention not required
{
    /**
     * @Route("/lucky/number/{max}", name="app_lucky_number")     //app_lucky_number would be autogenerated if not specified
     * need to include this if using annotations: use Symfony\Component\Routing\Annotation\Route;
     */
    public function number(Request $request, int $max): Response  //$max comes from {max} route param
    {
        //...
    }
}
```



## [Request Object](https://symfony.com/doc/5.4/components/http_foundation.html#component-http-foundation-request)

`Request` object stores all the route configs

Gives access to:
- route params
- query params
- request header
- uploaded file

```php
public function index(Request $request): Response
{
  $routeName = $request->attributes->get('_route'); 

  $routeParameters = $request->attributes->get('_route_params'); //{route params}
    //Array ( [page] => 1 )
  $allAttributes = $request->attributes->all();  //all the params, symfony and route params
    //Array ( [_stopwatch_token] => 9eb63e [_route] => app_lucky_number [page] => 1 [_controller] => App\Controller\LuckyController::number [_route_params] => Array ( [var] => 1 ) [_firewall_context] => security.firewall.map.context.main [_access_control_attributes] => ) 
  
  if($request->getMethod()){} //ex. returns "POST"

  $get_variables = $request->query->all(); // array of GET variables
  $get_variable = $request->query->get('page', false);  // GET variable "page", default to false
  $get_int_variable = $request->query->getDigits('id');  // GET variable "id" casted to int

  $post_variables = $request->all();  // array of POST variables
  $post_variable = $request->request->get('page');


  $server_vars = $request->server->get('HTTP_HOST');

  $files = $request->files->all();  // array of all uploaded files
  $files_named_foo = $request->files->get('foo');

  $cookie_val = $request->cookies->get('PHPSESSID');
}
```

## [Response Object](https://symfony.com/doc/5.4/components/http_foundation.html#component-http-foundation-request)

What the controller returns. 

- Could be HTML, JSON, XML, a file download, a redirect, a 404 error, or really anything

### $this->render()

Create a Response object with a twig template

`return $this->render('lucky/number.html.twig', ['number' => $number]);`

### $this->renderForm()

### Simple 200 Status Response

The default response (HTTP OK status)

```php
//simple response
$response = new Response('Hello '.$name, Response::HTTP_OK);
//css response
$response = new Response('<style>...</style>');
$response->headers->set('Content-Type', 'text/css');  //responses headers property
```

### Return JSON Response

Uses `json_encode` function (unless serializer service is enabled)

```php
return $this->json(['username' => 'jane.doe']);
// returns '{"username":"jane.doe"}' and sets the proper Content-Type header
// offers three optional arguments
// return $this->json($data, $status = 200, $headers = [], $context = []);
```

### Return File

```php
use Symfony\Component\HttpFoundation\File\File;
use Symfony\Component\HttpFoundation\ResponseHeaderBag;
// ...

public function download(): BinaryFileResponse
{
    // load the file from the filesystem
    $file = new \File('/path/to/some_file.pdf');

    // send the file contents and force the browser to download it
    return $this->file($file);

    // rename the downloaded file
    return $this->file($file, 'custom_name.pdf');

    // display the file contents in the browser instead of downloading it
    return $this->file('invoice_3241.pdf', 'my_invoice.pdf', ResponseHeaderBag::DISPOSITION_INLINE);
}
```

## Flash Message / Alert User

```php
$this->addFlash(
            'notice',
            'Your changes were saved!'
        );
// $this->addFlash() is equivalent to $request->getSession()->getFlashBag()->add()
```

## Generating URLs

Get a URL for a given route

`$url = $this->generateUrl('app_lucky_number', ['max'=> 10]);  // '/lucky/number/10'`

## Redirecting

### Redirect to another route

`return $this->redirectToRoute($route_name)`
- shortcut for `return new RedirectResponse($this->generateUrl('homepage'));`
- do a permanent HTTP 301 redirect `$this->redirectToRoute('homepage', ['max' => 10], 301);`
  - PHP constant instead of 301 `Response::HTTP_MOVED_PERMANENTLY`
- maintain the original query string parameters `redirectToRoute('blog_show', $request->query->all()`

### Redirect to External Site

`redirect()`
- redirect externally `return $this->redirect('http://symfony.com/doc');`

### [Redirect to another Page](https://symfony.com/doc/5.4/controller/forwarding.html) 

Not common

## Fetch Services | Autowire

Pass a service into a controller with a type-hint argument

*aka Type-wire, type-hinting*

```php
use Psr\Log\LoggerInterface;
use Symfony\Component\HttpFoundation\Response;
// ...

/**
 * @Route("/lucky/number/{max}")
 */
public function number(int $max, LoggerInterface $logger): Response
{
    $logger->info('We are logging!');
    // ...
}
```

### See List of Autowire Compatible Services

`$ php bin/console debug:autowiring`

### Change Type-Hint Conversion | Doesn't Extend AbstractController

```yaml
# config/services.yaml
services:
    # ...

    # explicitly configure the service
    App\Controller\LuckyController:
        tags: [controller.service_arguments]
        bind:
            # for any $logger argument, pass this specific service
            $logger: '@monolog.logger.doctrine'
            # for any $projectDir argument, pass this parameter value
            $projectDir: '%kernel.project_dir%'
```

## Access env / Configuration Values

`$this->getParameter('kernel.project_dir').'/contents';`
`$this->getParameter('api_key');`

## [Generate a Controller w/ bin/console](https://symfony.com/doc/current/bundles/SymfonyMakerBundle/index.html)

Install
`$ composer require --dev symfony/maker-bundle`

Usage
```bash
$ php bin/console list make

 make:command            Creates a new console command class
 make:controller         Creates a new controller class
 make:entity             Creates a new Doctrine entity class
```

Make a controller example
```bash
$ php bin/console make:controller BrandNewController

created: src/Controller/BrandNewController.php
created: templates/brandnew/index.html.twig
```

Make an entire CRUD from a Doctrine entity
```bash
$ php bin/console make:crud Product

created: src/Controller/ProductController.php
created: src/Form/ProductType.php
created: templates/product/_delete_form.html.twig
created: templates/product/_form.html.twig
created: templates/product/edit.html.twig
created: templates/product/index.html.twig
created: templates/product/new.html.twig
created: templates/product/show.html.twig
```

## Manage Errors

- Error page will show to end user in PROD mode
- A full debug error page will show when in "Debug" mode

### 404 HTTP status code

Should generate when things are not found

```php
use Symfony\Component\HttpKernel\Exception\NotFoundHttpException;
public function show(Product $product): Response
{
  if (!$product)
    throw $this->createNotFoundException('The product does not exist');
    // throw new NotFoundHttpException('The product does not exist');
}
```

### 500 HTTP status code

Generic error code

```php
throw new \Exception('Something went wrong!');
```

### [Customize Error Page](https://symfony.com/doc/5.4/controller/error_pages.html)

## [Extending Action Argument Resolving ?](https://symfony.com/doc/5.4/controller/argument_value_resolver.html)
